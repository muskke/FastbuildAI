# å®šä¹‰é€šç”¨èµ„æºé…ç½®
x-resource-config: &resource-config
    deploy:
        resources:
            limits:
                memory: ${DOCKER_MEMORY_LIMIT:-3584M}
                cpus: "${DOCKER_CPU_LIMIT:-1.0}"
            reservations:
                memory: ${DOCKER_MEMORY_RESERVATION:-512M}

services:
    # Redis ç¼“å­˜æœåŠ¡
    redis:
        image: ccr.ccs.tencentyun.com/buildingai/redis:8.2.2
        container_name: buildingai-redis${DOCKER_CONTAINER_SUFFIX:-}
        restart: always
        environment:
            TZ: Asia/Shanghai
            REDIS_PASSWORD: ${REDIS_PASSWORD:-}
            QUICK_START_MODE: ${QUICK_START_MODE:-false}
        ports:
            - "${REDIS_EXTERNAL_PORT:-}${REDIS_EXTERNAL_PORT:+:}6379"
        volumes:
            - ./data/redis:/data
        networks:
            - buildingai-network
        <<: *resource-config
        healthcheck:
            test: ["CMD-SHELL", "redis-cli -a $$REDIS_PASSWORD ping"]
            interval: 10s
            timeout: 5s
            retries: 5

    # PostgreSQL æ•°æ®åº“æœåŠ¡ (with pgvector)
    postgres:
        image: ccr.ccs.tencentyun.com/buildingai/postgres:17.6
        container_name: buildingai-postgres${DOCKER_CONTAINER_SUFFIX:-}
        restart: always
        environment:
            TZ: Asia/Shanghai
            POSTGRES_USER: ${DB_USERNAME:-postgres}
            POSTGRES_PASSWORD: ${DB_PASSWORD:-postgres}
            POSTGRES_DB: ${DB_DATABASE:-buildingai}
        ports:
            - "${POSTGRES_EXTERNAL_PORT:-}${POSTGRES_EXTERNAL_PORT:+:}5432"
        volumes:
            - ./data/postgres/postgres_data:/var/lib/postgresql/data
        networks:
            - buildingai-network
        <<: *resource-config
        healthcheck:
            test: ["CMD-SHELL", "pg_isready -U ${DB_USERNAME:-postgres}"]
            interval: 10s
            timeout: 5s
            retries: 5

    # Node.js å¼€å‘ç¯å¢ƒ
    nodejs:
        image: ccr.ccs.tencentyun.com/buildingai/node:22.20.0
        container_name: buildingai-nodejs${DOCKER_CONTAINER_SUFFIX:-}
        restart: on-failure:3
        working_dir: /buildingai
        volumes:
            - ../:/buildingai
            - /buildingai/node_modules
            - /buildingai/apps/server/node_modules
            - /buildingai/apps/web/node_modules
            - /buildingai/apps/mobile/node_modules
            - /buildingai/packages/assets/node_modules
            - /buildingai/packages/config/node_modules
            - /buildingai/packages/designer/node_modules
            - /buildingai/packages/http/node_modules
            - /buildingai/packages/ui/node_modules
            - /buildingai/packages/utils/node_modules
        ports:
            - "${SERVER_PORT:-4090}:${SERVER_PORT:-4090}"
        environment:
            TZ: Asia/Shanghai
            SERVER_PORT: ${SERVER_PORT:-4090}
            QUICK_START_MODE: ${QUICK_START_MODE:-false}
            NPM_REGISTRY_URL: ${NPM_REGISTRY_URL:-}
            DB_USERNAME: ${DB_USERNAME:-postgres}
            DB_PASSWORD: ${DB_PASSWORD:-postgres}
            DB_DATABASE: ${DB_DATABASE:-buildingai}
            DB_HOST: postgres
            DB_PORT: 5432
            REDIS_HOST: redis
            REDIS_PORT: 6379
            REDIS_PASSWORD: ${REDIS_PASSWORD:-}
        command: |
            sh -c '
            set -e
            echo "ğŸš€ Starting BuildingAI container..."

            if [ -z "$QUICK_START_MODE" ]; then
            QUICK_START_MODE="false"
            echo "âš ï¸  QUICK_START_MODE is empty, setting default value: false"
            fi      

            echo "ğŸ” Debug: QUICK_START_MODE = [$QUICK_START_MODE]"

            # å…ˆæ£€æŸ¥å¹¶è®¾ç½®é•œåƒ
            if [ -n "$NPM_REGISTRY_URL" ]; then
            echo "ğŸ”§ Using custom registry: $NPM_REGISTRY_URL"
            if command -v npm >/dev/null 2>&1; then
                npm config set registry "$NPM_REGISTRY_URL"
            fi
            if command -v pnpm >/dev/null 2>&1; then
                pnpm config set registry "$NPM_REGISTRY_URL"
            fi
            else
            echo "âš ï¸ NPM_REGISTRY_URL not set, using default registry"
            fi

            # å†æ£€æŸ¥å¹¶å®‰è£… pnpm
            if ! command -v pnpm >/dev/null 2>&1; then
            echo "ğŸ“¦ Installing pnpm..."
            npm install -g pnpm
            # å®‰è£…å®Œ pnpm åå†æ¬¡è®¾ç½®é•œåƒ
            if [ -n "$NPM_REGISTRY_URL" ]; then
                pnpm config set registry "$NPM_REGISTRY_URL"
            fi
            fi

            # ç»Ÿä¸€ store åˆ°é¡¹ç›®ç›®å½•ï¼Œé¿å…å®¿ä¸»æœº ~/.pnpm-store æƒé™é—®é¢˜
            echo "ğŸ”§ Setting pnpm store directory..."
            pnpm config set store-dir .pnpm-store

            # ç¡®ä¿ç›®å½•å­˜åœ¨
            echo "ğŸ“ Creating directories..."
            mkdir -p /buildingai/.pnpm-store /buildingai/node_modules

            # åªä¿®é¡¶å±‚ç›®å½•æƒé™
            echo "ğŸ§¹ Fixing permissions..."
            chown $(id -u):$(id -g) /buildingai/.pnpm-store /buildingai/node_modules || true
            chmod 775 /buildingai/.pnpm-store /buildingai/node_modules || true

            # å®‰è£…ä¾èµ–
            echo "ğŸ“¦ Installing dependencies..."

            if [ -d "node_modules" ]; then
            echo "ğŸ“ node_modules exists, using force install..."
            yes | pnpm install --store-dir .pnpm-store
            else
            echo "ğŸ“ node_modules not found, installing..."
            yes | pnpm install --store-dir .pnpm-store
            fi

            echo "âœ… Install dependencies completed!"

            if [ ! -f "/buildingai/public/index.html" ] || [ "$QUICK_START_MODE" = "false" ]; then
            echo "ğŸŒ Building web application..."
            pnpm --filter ./apps/web run generate
            fi

            if [ ! -d "/buildingai/apps/server/dist" ] || [ "$QUICK_START_MODE" = "false" ]; then
            echo "ğŸ”§ Building server application..."
            pnpm --filter ./apps/server run build
            fi

            echo "ğŸ” Debug: QUICK_START_MODE = [$QUICK_START_MODE]"
            echo "ğŸ¯ Starting production server..."
            exec pnpm --filter ./apps/server run start:prod
            '
        networks:
            - buildingai-network
        <<: *resource-config
        depends_on:
            redis:
                condition: service_healthy
            postgres:
                condition: service_healthy
        healthcheck:
            test: ["CMD-SHELL", "ps aux | grep 'dist/main' | grep -v grep || exit 1"]
            interval: 30s
            timeout: 10s
            retries: 10
            start_period: 180s

networks:
    buildingai-network:
        driver: bridge
