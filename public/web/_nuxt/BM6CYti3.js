import{c as R}from"./B1XcE43x.js";import{f as u,g as j,af as F,ao as J}from"#entry";const x=()=>"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,g=>{const v=Math.random()*16|0;return(g==="x"?v:v&3|8).toString(16)});function W(g={}){const{api:v,initialMessages:y=[],body:p={},onResponse:U,onUpdate:I,onError:C,onFinish:S,onToolCall:M,chatConfig:k}=g,a=u([...y]),f=u(""),c=u([]),o=u("idle"),d=u(null),r=u(null),E=j(()=>k||{}),D=e=>{a.value=[...e]},h=async e=>{const n={id:x(),...e};a.value.push(n),e.role==="user"&&await T()},T=async()=>{if(o.value==="loading")return;o.value="loading",d.value=null;const e={id:x(),role:"assistant",content:"",status:"loading",mcpToolCalls:[],avatar:E.value.avatar};a.value.push(e);try{const n=a.value.slice(0,-1).map(t=>({role:t.role,content:t.content})),l=v||R,m=JSON.parse(JSON.stringify({...p,modelId:p.modelId,conversationId:p.conversationId})),w=()=>{if(e.metadata?.reasoning?.startTime&&!e.metadata.reasoning.endTime){const t=Date.now();e.metadata.reasoning.endTime=t,e.metadata.reasoning.duration=t-e.metadata.reasoning.startTime}};r.value=await l(n,{body:m,onResponse:U,onUpdate(t){if(t.delta&&(w(),e.content+=t.delta,e.status="active",a.value=[...a.value]),t.type==="metadata"&&t.metadata){e.metadata||(e.metadata={});const{type:i,data:s}=t.metadata;switch(i){case"context":e.metadata.context=s;break;case"references":e.metadata.references=s;break;case"suggestions":e.metadata.suggestions=s;break;case"tokenUsage":e.metadata.tokenUsage=s;break;case"conversation_id":I?.({type:"conversation_id",data:s});break;case"annotations":e.metadata.annotations=s;break;case"reasoning":e.metadata.reasoning?e.metadata.reasoning.content+=s:e.metadata.reasoning={content:s,startTime:Date.now()};break;default:e.metadata[i]=s}a.value=[...a.value]}},onToolCall(t){const i=t.data;e.status="active",e.mcpToolCalls||(e.mcpToolCalls=[]);const s=e.mcpToolCalls.findIndex(O=>O.id===i.id);s!==-1?e.mcpToolCalls[s]=i:e.mcpToolCalls.push(i),M?.(i),a.value=[...a.value]},onFinish(t){e.status="completed",e.content=t.content||e.content,w(),a.value=[...a.value],r.value=null,o.value="idle",S?.(e),J().getUser()},onError(t){if(t.message==="BodyStreamBuffer was aborted"){e.status="completed",o.value="idle";return}e.status="failed",e.content=t.message||e.content,a.value=[...a.value],r.value=null,o.value="error",d.value=t,C?.(t)}})}catch(n){const l=n instanceof Error?n:new Error(String(n));e.status="failed",a.value=[...a.value],r.value=null,o.value="error",d.value=l,C?.(l)}},A=async e=>{e&&typeof e=="object"&&"preventDefault"in e&&e.preventDefault();const n=typeof e=="string"?e:f.value.trim();if(!n&&!c.value.length||o.value==="loading")return;let l=n;if(c.value.length>0){const m=[...c.value];n&&m.push({type:"text",text:n}),l=m}f.value="",c.value=[],await h({id:x(),role:"user",content:l,status:"completed",mcpToolCalls:[]})},B=async()=>{if(a.value.length===0)return;o.value="idle",d.value=null;const e=a.value.map((n,l)=>({msg:n,index:l})).reverse().find(({msg:n})=>n.role==="user")?.index;e!==void 0&&(a.value=a.value.slice(0,e+1),await T())},b=()=>{if(r.value){r.value.abort(),r.value=null,o.value="completed";const e=a.value[a.value.length-1];e?.role==="assistant"&&(e.status="completed",a.value=[...a.value])}};return F(()=>b()),{messages:a,input:f,files:c,status:o,error:d,handleSubmit:A,reload:B,stop:b,setMessages:D,append:h}}export{W as u};
