const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./CnRno43X.js","./IZm275qp.js","./Dg6D3RQ3.js","./DS-TE4M7.js","./BgHJjJs-.js","./CoK0jBu7.js","./CQBV3TNh.js","./BFVs1AfH.js","./DHFmmngs.js","./kRIii9yh.js","./Btvd554H.js","./MN31c9CG.js","./C6Y-ieo6.js","./BPKB8n-W.js","./B-DdbQ-X.js","./V9POJiZu.js","./CuOaO1Pb.js","./D6yWePie.js","./DuSMYVIA.js","./3UOIlTK8.js","./DduSJdeS.js","./VGKgjfSv.js","./Dkb19qXD.js","./BMSQkwth.js","./DaWZu8wl.js","./5XG8SC4l.js","./CR1AS2Ry.js","./C3zg6GHm.js","./D-6Co9ha.js","./CXUt0j5Y.js","./-Eb02sIQ.js","./Dk6FGhu1.js","./CCcv9mzY.js","./BFAo_s2U.js","./Cb04SOqd.js","./ChM0pAjz.js","./D-hk-k_E.js","./BUyfW8JT.js","./BNXi4epI.js","./i5AwkGQh.js","./BcsO9TDZ.js","./DlAUqK2U.js","./C304YI96.js","./BruVSCWF.js","./CRoF6I1E.js","./BstbYvQo.js"])))=>i.map(i=>d[i]);
import{d as fe,aI as ge,ao as D,b as ve,ap as _e,e as he,aM as ke,Q as be,g as O,s as B,aR as ye,w as Ce,G as Q,i as we,af as xe,c as u,o as r,j as k,t as g,l as m,q as p,p as n,R as T,k as _,v as b,F as S,B as U,_ as Ie,y as Ae,A as Fe,U as P,br as Se}from"#entry";import{_ as Ee}from"./DfmzrqHf.js";import{_ as Re,a as Ve}from"./lwzf8G4w.js";import{_ as Me}from"./COxNVqQJ.js";import{_ as $e}from"./RuzXXHQK.js";import{_ as Be}from"./i5AwkGQh.js";import{_ as Te}from"./BkAysFbf.js";import{p as Ue,o as Pe}from"./ChM0pAjz.js";import{u as Le}from"./BM6CYti3.js";import"./BMSQkwth.js";import"./DaWZu8wl.js";import"./BygQEAzM.js";import"./Cif_tCX1.js";import"./DGIb7fSK.js";import"./Btvd554H.js";import"./3UOIlTK8.js";import"./DuSMYVIA.js";import"./DduSJdeS.js";import"./VGKgjfSv.js";import"./BdImEx5p.js";import"./oFTPHjuc.js";import"./BcsO9TDZ.js";import"./BP0i4hNs.js";import"./BV27uQF0.js";import"./D5P4scfL.js";import"./DiYXikHi.js";import"./C7UmhjTd.js";import"./BFVs1AfH.js";import"./DHFmmngs.js";import"./kRIii9yh.js";import"./MN31c9CG.js";import"./C6Y-ieo6.js";import"./BPKB8n-W.js";import"./B-DdbQ-X.js";import"./V9POJiZu.js";import"./CuOaO1Pb.js";import"./D6yWePie.js";import"./Dx01Lm3C.js";import"./DlAUqK2U.js";import"./Dg6D3RQ3.js";import"./BruVSCWF.js";import"./C1DLXs69.js";import"./B1XcE43x.js";const qe={class:"flex h-full min-h-0 w-full flex-col"},De={class:"flex flex-col gap-2"},Oe={class:"text-muted-foreground text-sm"},Qe={key:0,class:"flex items-center gap-2"},Ne={class:"my-2 flex items-center gap-1"},ze={class:"text-muted-foreground flex-none text-xs"},He={key:1,class:"mt-2 flex items-center gap-1"},je={class:"text-muted-foreground flex-none text-xs"},Ge={key:1,class:"mb-2 space-y-2"},Ke={class:"px-4 pb-4"},Je={class:"flex gap-2 pb-4"},Dt=fe({__name:"preview-chat",props:{agent:{},showVariableInput:{type:Boolean}},emits:["update:agent"],setup(d,{expose:N,emit:z}){const H=T(()=>P(()=>import("./CnRno43X.js"),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37]),import.meta.url)),j=T(()=>P(()=>import("./BNXi4epI.js"),__vite__mapDeps([38,39,1,40,41,29,30,31,13,18,11,32,33,34,21]),import.meta.url)),G=T(()=>P(()=>import("./C304YI96.js"),__vite__mapDeps([42,43,1,3,4,2,44,8,26,10,13,14,15,11,45,18,28,37,24]),import.meta.url)),K=z,J=d,{params:W}=ge(),X=D(),{t:s}=ve(),x=_e(),y=he("scrollAreaRef"),{height:Y}=ke(y),L=be(),o=ye(J,"agent",K),I=O(()=>W.id),E=B(null),Z=[],ee=B([]),{messages:l,input:R,handleSubmit:te,reload:ae,stop:ne,status:oe,error:re}=Le({api:Ue,initialMessages:Z,chatConfig:{get avatar(){return o.value.chatAvatar}},body:{agentId:I.value,saveConversation:!1,get conversationId(){return E.value},get modelConfig(){return o.value.modelConfig},get mcpServerIds(){return o.value.mcpServerIds},get datasetIds(){return o.value.datasetIds},get rolePrompt(){return o.value.rolePrompt},get showContext(){return o.value.showContext},get showReference(){return o.value.showReference},get enableFeedback(){return o.value.enableFeedback},get autoQuestions(){return o.value.autoQuestions},get formFields(){return o.value.formFields},get formFieldsInputs(){return o.value.formFieldsInputs},get quickCommands(){return o.value.quickCommands},get thirdPartyIntegration(){return o.value.thirdPartyIntegration}},onToolCall(){},onResponse(a){a.status===401&&D().logout(!0)},onUpdate(a){a.type==="conversation_id"&&(E.value=a.data)},onError(a){const t=a?.message||"发送失败";console.error("聊天错误:",t)},onFinish(){}}),A=O(()=>oe.value==="loading"),V=B(!0);function M(a){const t=a.target,c=40;V.value=t.scrollHeight-(t.scrollTop+t.clientHeight)<=c}async function C(a=!0){await Q(),y.value?.scrollToBottom(a)}async function F(a){if(!a.trim()||A.value)return;if(!o.value.modelConfig?.id&&o.value.createMode==="direct")return x.warning(s("ai-agent.backend.configuration.modelNotConfigured"));const t=o.value.formFields||[],c=o.value.formFieldsInputs||{};if(t.length>0){const i=[];if(t.forEach(h=>{if(h.required){const w=c[h.name];(!w||typeof w=="string"&&w.trim()==="")&&i.push(`${h.label}${s("ai-agent.backend.configuration.notEmpty")}`)}}),i.length>0){x.error(`${s("ai-agent.backend.configuration.formVariableTitle")}: ${i.join(", ")}`);return}}await te(a),C()}const se=a=>{ee.value=a,L.create(j).open({context:a})},ie=(a,t=null)=>{L.create(H).open({agentId:I.value,annotationId:a,messageId:t})};async function le(a,t){const c=l.value[t-1];if(!c||c.role!=="user"){x.error(s("ai-agent.backend.configuration.noUserQuestion"));return}try{const i=await Pe(I.value,{agentId:I.value,question:c.content.toString(),answer:a.content.toString(),enabled:!0,messageId:a.id});l.value[t]?.metadata||l.value[t]&&(l.value[t].metadata={}),l.value[t]?.metadata&&(l.value[t].metadata.annotations={annotationId:i.id,createdBy:X.userInfo?.nickname,question:i.question,similarity:1})}catch(i){console.error("创建标注失败:",i)}}Ce(()=>l.value.at(-1)?.content,()=>Q(()=>{V.value&&C(!1)}),{flush:"post"});let $=null;return we(async()=>{C(!1);const a=y.value?.getViewportElement(),t=a&&a.viewportElement;t?.addEventListener("scroll",M,{passive:!0}),t&&(M({target:t}),$=new MutationObserver(()=>{V.value&&C(!1)}),$.observe(t,{childList:!0,subtree:!0,characterData:!0}))}),xe(()=>{const a=y.value?.getViewportElement();(a&&a.viewportElement)?.removeEventListener("scroll",M),$?.disconnect()}),N({clearRecord(){l.value=[],E.value=null}}),(a,t)=>{const c=Ee,i=Ie,h=Ve,w=Ae,q=Me,ce=$e,ue=Re,me=Be,de=Se,pe=Te;return r(),u("div",qe,[d.showVariableInput&&n(o).formFields&&n(o).formFields.length>0?(r(),k(n(G),{key:0,inputs:n(o).formFieldsInputs,"onUpdate:inputs":t[0]||(t[0]=e=>n(o).formFieldsInputs=e),formFields:n(o).formFields,class:"mx-4 mt-2",formClass:"bg-muted hover:bg-muted"},null,8,["inputs","formFields"])):g("",!0),m(me,{class:"min-h-0 w-full flex-1",type:"auto",ref_key:"scrollAreaRef",ref:y,onInView:t[1]||(t[1]=e=>C(!1))},{default:_(()=>[m(ue,{loading:!1,"has-more":!1,threshold:500,"content-class":"w-full space-y-3 p-4 "},{default:_(()=>[n(l).length===0?(r(),k(h,{key:0,messages:[{role:"assistant",avatar:d.agent.chatAvatar,content:d.agent.openingStatement}],"scroll-area-height":200,assistant:{actions:[]}},{content:_(({message:e})=>[m(c,{content:e.content.toString(),class:"mb-2"},null,8,["content"]),p("div",De,[p("div",Oe,b(n(s)("ai-agent.backend.configuration.youCanAskMe")),1),(r(!0),u(S,null,U(d.agent.openingQuestions,f=>(r(),u("div",{key:f},[m(i,{label:f,color:"primary",variant:"soft",onClick:v=>F(f)},null,8,["label","onClick"])]))),128))])]),_:1},8,["messages"])):(r(),k(h,{key:1,messages:n(l),"scroll-area-height":n(Y),error:n(re),assistant:{actions:[{label:n(s)("ai-chat.frontend.messages.retry"),icon:"i-lucide-rotate-cw-square",onClick:()=>n(ae)()},{label:n(s)("ai-agent.backend.configuration.chatContext"),icon:"i-lucide-file-type",show:!d.agent.showContext,onClick:e=>{e?.metadata?.context?se(e.metadata.context):n(x).error(n(s)("ai-agent.backend.configuration.noChatContext"))}},{label:n(s)("ai-agent.backend.configuration.feedback"),icon:"i-lucide-wrap-text",show:!d.agent.enableFeedback,onClick:(e,f)=>{const v=e.metadata?.annotations?.annotationId;v?ie(v,e.id):le(e,f)}}]},"spacing-offset":160},{content:_(({message:e,index:f})=>[e.content.length||e.metadata?.references&&e.metadata.references.length?(r(),k(c,{key:0,content:e.content.toString()},{before:_(()=>[e.status==="loading"?(r(),u("div",Qe,[m(w,{name:"i-lucide-loader-2",class:"animate-spin"}),p("span",null,b(n(s)("ai-chat.frontend.messages.thinking")),1)])):g("",!0)]),after:_(()=>[e.metadata?.references&&e.metadata.references.length>0&&e.role==="assistant"&&!n(A)&&d.agent.showReference?(r(),u(S,{key:0},[p("div",Ne,[p("span",ze,b(n(s)("ai-agent.backend.configuration.referenceTitle")),1),e.metadata?.references&&e.metadata.references.length>0&&e.role==="assistant"?(r(),k(q,{key:0,size:"xs",type:"dashed"})):g("",!0)]),m(ce,{references:e.metadata.references},null,8,["references"])],64)):g("",!0),e.metadata?.annotations&&e.role==="assistant"&&!n(A)?(r(),u("div",He,[p("span",je,b(e.metadata?.annotations?.createdBy)+" "+b(n(s)("ai-agent.backend.configuration.editedAnswer")),1),m(q,{size:"xs",type:"dashed"})])):g("",!0)]),_:2},1032,["content"])):g("",!0),e.metadata?.suggestions&&n(l).length-1===f?(r(),u("div",Ge,[(r(!0),u(S,null,U(e.metadata.suggestions,v=>(r(),u("div",{key:v},[m(i,{label:v,color:"primary",variant:"soft",onClick:We=>F(v)},null,8,["label","onClick"])]))),128))])):g("",!0)]),_:1},8,["messages","scroll-area-height","error","assistant"]))]),_:1})]),_:1},512),p("div",Ke,[p("div",Je,[(r(!0),u(S,null,U(d.agent.quickCommands,e=>(r(),u("div",{key:e.name},[m(i,{color:"neutral",variant:"soft",onClick:f=>F(e.content)},{default:_(()=>[e.avatar?(r(),k(de,{key:0,src:e.avatar,class:"h-4 w-4"},null,8,["src"])):g("",!0),p("span",null,b(e.name),1)]),_:2},1032,["onClick"])]))),128))]),m(pe,{modelValue:n(R),"onUpdate:modelValue":t[2]||(t[2]=e=>Fe(R)?R.value=e:null),"is-loading":n(A),class:"sticky bottom-0 z-10 [view-transition-name:chat-prompt]",onStop:n(ne),onSubmit:F},null,8,["modelValue","is-loading","onStop"])])])}}});export{Dt as default};
