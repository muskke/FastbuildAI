const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./Do-VSyvA.js","./CpacWlXu.js","./CfxLE1oh.js","./BYwSSEjb.js","./BgHJjJs-.js","./iqoKNu2e.js","./B1Lg5z9T.js","./CLTNKp0S.js","./8-c-A7PB.js","./kRIii9yh.js","./TH-3OOuG.js","./Cfcu-t3n.js","./C6Y-ieo6.js","./b-_TUx9i.js","./DaNf1Wdt.js","./CKXZhss7.js","./Cpt2kRVT.js","./pUN2d83w.js","./B22A-h4k.js","./Bub1HYiY.js","./lw_U4-W2.js","./XpsTG8vq.js","./DyWX1Ime.js","./BMSQkwth.js","./DaWZu8wl.js","./B_gLqRAo.js","./ZZC6mEJB.js","./DN9ov8OT.js","./nBDBqKnC.js","./DNgvVYsj.js","./BYK_1AlN.js","./BJ_E6Ph7.js","./DSMB-qMT.js","./B128ot1i.js","./CoMGTw2w.js","./CP4Zo7YT.js","./BDS0FVMi.js","./DTJhkpWV.js","./BUyfW8JT.js","./BpWKzIts.js","./D-yR6Fj9.js","./Dn8X9Gvz.js","./DlAUqK2U.js","./BhaAGfJt.js","./--UdezPG.js","./EHoVw6ZP.js","./BstbYvQo.js"])))=>i.map(i=>d[i]);
import{d as fe,aJ as ge,ap as D,b as ve,aq as _e,e as he,aN as ke,Q as be,g as N,s as M,aS as ye,w as Ce,G as O,i as we,ah as xe,c as u,o as r,j as k,t as g,l as m,q as p,p as n,R as T,k as _,v as b,F,B as U,_ as Ie,y as Se,A as Ae,U as P,bs as Fe}from"#entry";import{_ as Ee}from"./Bfc6LCc8.js";import{_ as Re,a as Ve}from"./l1H0tvBk.js";import{_ as $e}from"./Bu7cOM_l.js";import{_ as Be}from"./BvA0VnH0.js";import{_ as Me}from"./D-yR6Fj9.js";import{_ as Te}from"./CdEI2ZYD.js";import{p as Ue,o as Pe}from"./BDS0FVMi.js";import{u as Le}from"./DqNHTeRY.js";import"./BMSQkwth.js";import"./DaWZu8wl.js";import"./B9WZOnAv.js";import"./CBooyAK7.js";import"./BqoA6bN6.js";import"./TH-3OOuG.js";import"./Bub1HYiY.js";import"./B22A-h4k.js";import"./lw_U4-W2.js";import"./XpsTG8vq.js";import"./BaNg8fjw.js";import"./BvoFq0Fi.js";import"./BI1JbAYD.js";import"./ADUcesrP.js";import"./2ydT-KR3.js";import"./Dn8X9Gvz.js";import"./B_gLqRAo.js";import"./DBjGnECu.js";import"./BO1GPLSL.js";import"./CLTNKp0S.js";import"./8-c-A7PB.js";import"./kRIii9yh.js";import"./Cfcu-t3n.js";import"./C6Y-ieo6.js";import"./b-_TUx9i.js";import"./DaNf1Wdt.js";import"./CKXZhss7.js";import"./Cpt2kRVT.js";import"./pUN2d83w.js";import"./DqVgEjI6.js";import"./DlAUqK2U.js";import"./CfxLE1oh.js";import"./--UdezPG.js";import"./C1DLXs69.js";import"./B1XcE43x.js";const qe={class:"flex h-full min-h-0 w-full flex-col"},De={class:"flex flex-col gap-2"},Ne={class:"text-muted-foreground text-sm"},Oe={key:0,class:"flex items-center gap-2"},Qe={class:"my-2 flex items-center gap-1"},ze={class:"text-muted-foreground flex-none text-xs"},He={key:1,class:"mt-2 flex items-center gap-1"},je={class:"text-muted-foreground flex-none text-xs"},Ge={key:1,class:"mb-2 space-y-2"},Je={class:"px-4 pb-4"},Ke={class:"flex gap-2 pb-4"},Nt=fe({__name:"preview-chat",props:{agent:{},showVariableInput:{type:Boolean}},emits:["update:agent"],setup(d,{expose:Q,emit:z}){const H=T(()=>P(()=>import("./Do-VSyvA.js"),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38]),import.meta.url)),j=T(()=>P(()=>import("./BpWKzIts.js"),__vite__mapDeps([39,40,1,41,42,30,31,32,13,18,11,33,34,35,21]),import.meta.url)),G=T(()=>P(()=>import("./BhaAGfJt.js"),__vite__mapDeps([43,44,1,3,4,2,45,8,27,10,13,14,15,11,46,18,29,38,24]),import.meta.url)),J=z,K=d,{params:W}=ge(),X=D(),{t:s}=ve(),x=_e(),y=he("scrollAreaRef"),{height:Y}=ke(y),L=be(),o=ye(K,"agent",J),I=N(()=>W.id),E=M(null),Z=[],ee=M([]),{messages:l,input:R,handleSubmit:te,reload:ae,stop:ne,status:oe,error:re}=Le({api:Ue,initialMessages:Z,chatConfig:{get avatar(){return o.value.chatAvatar}},body:{agentId:I.value,saveConversation:!1,get conversationId(){return E.value},get modelConfig(){return o.value.modelConfig},get mcpServerIds(){return o.value.mcpServerIds},get datasetIds(){return o.value.datasetIds},get rolePrompt(){return o.value.rolePrompt},get showContext(){return o.value.showContext},get showReference(){return o.value.showReference},get enableFeedback(){return o.value.enableFeedback},get autoQuestions(){return o.value.autoQuestions},get formFields(){return o.value.formFields},get formFieldsInputs(){return o.value.formFieldsInputs},get quickCommands(){return o.value.quickCommands},get thirdPartyIntegration(){return o.value.thirdPartyIntegration}},onToolCall(){},onResponse(a){a.status===401&&D().logout(!0)},onUpdate(a){a.type==="conversation_id"&&(E.value=a.data)},onError(a){const t=a?.message||"发送失败";console.error("聊天错误:",t)},onFinish(){}}),S=N(()=>oe.value==="loading"),V=M(!0);function $(a){const t=a.target,c=40;V.value=t.scrollHeight-(t.scrollTop+t.clientHeight)<=c}async function C(a=!0){await O(),y.value?.scrollToBottom(a)}async function A(a){if(!a.trim()||S.value)return;if(!o.value.modelConfig?.id&&o.value.createMode==="direct")return x.warning(s("ai-agent.backend.configuration.modelNotConfigured"));const t=o.value.formFields||[],c=o.value.formFieldsInputs||{};if(t.length>0){const i=[];if(t.forEach(h=>{if(h.required){const w=c[h.name];(!w||typeof w=="string"&&w.trim()==="")&&i.push(`${h.label}${s("ai-agent.backend.configuration.notEmpty")}`)}}),i.length>0){x.error(`${s("ai-agent.backend.configuration.formVariableTitle")}: ${i.join(", ")}`);return}}await te(a),C()}const se=a=>{ee.value=a,L.create(j).open({context:a})},ie=(a,t=null)=>{L.create(H).open({agentId:I.value,annotationId:a,messageId:t})};async function le(a,t){const c=l.value[t-1];if(!c||c.role!=="user"){x.error(s("ai-agent.backend.configuration.noUserQuestion"));return}try{const i=await Pe(I.value,{agentId:I.value,question:c.content.toString(),answer:a.content.toString(),enabled:!0,messageId:a.id});l.value[t]?.metadata||l.value[t]&&(l.value[t].metadata={}),l.value[t]?.metadata&&(l.value[t].metadata.annotations={annotationId:i.id,createdBy:X.userInfo?.nickname,question:i.question,similarity:1})}catch(i){console.error("创建标注失败:",i)}}Ce(()=>l.value.at(-1)?.content,()=>O(()=>{V.value&&C(!1)}),{flush:"post"});let B=null;return we(async()=>{C(!1);const a=y.value?.getViewportElement(),t=a&&a.viewportElement;t?.addEventListener("scroll",$,{passive:!0}),t&&($({target:t}),B=new MutationObserver(()=>{V.value&&C(!1)}),B.observe(t,{childList:!0,subtree:!0,characterData:!0}))}),xe(()=>{const a=y.value?.getViewportElement();(a&&a.viewportElement)?.removeEventListener("scroll",$),B?.disconnect()}),Q({clearRecord(){l.value=[],E.value=null}}),(a,t)=>{const c=Ee,i=Ie,h=Ve,w=Se,q=$e,ce=Be,ue=Re,me=Me,de=Fe,pe=Te;return r(),u("div",qe,[d.showVariableInput&&n(o).formFields&&n(o).formFields.length>0?(r(),k(n(G),{key:0,inputs:n(o).formFieldsInputs,"onUpdate:inputs":t[0]||(t[0]=e=>n(o).formFieldsInputs=e),formFields:n(o).formFields,class:"mx-4 mt-2",formClass:"bg-muted hover:bg-muted"},null,8,["inputs","formFields"])):g("",!0),m(me,{class:"min-h-0 w-full flex-1",type:"auto",ref_key:"scrollAreaRef",ref:y,onInView:t[1]||(t[1]=e=>C(!1))},{default:_(()=>[m(ue,{loading:!1,"has-more":!1,threshold:500,"content-class":"w-full space-y-3 p-4 "},{default:_(()=>[n(l).length===0?(r(),k(h,{key:0,messages:[{role:"assistant",avatar:d.agent.chatAvatar,content:d.agent.openingStatement}],"scroll-area-height":200,assistant:{actions:[]}},{content:_(({message:e})=>[m(c,{content:e.content.toString(),class:"mb-2"},null,8,["content"]),p("div",De,[p("div",Ne,b(n(s)("ai-agent.backend.configuration.youCanAskMe")),1),(r(!0),u(F,null,U(d.agent.openingQuestions,f=>(r(),u("div",{key:f},[m(i,{label:f,color:"primary",variant:"soft",onClick:v=>A(f)},null,8,["label","onClick"])]))),128))])]),_:1},8,["messages"])):(r(),k(h,{key:1,messages:n(l),"scroll-area-height":n(Y),error:n(re),assistant:{actions:[{label:n(s)("ai-chat.frontend.messages.retry"),icon:"i-lucide-rotate-cw-square",onClick:()=>n(ae)()},{label:n(s)("ai-agent.backend.configuration.chatContext"),icon:"i-lucide-file-type",show:!d.agent.showContext,onClick:e=>{e?.metadata?.context?se(e.metadata.context):n(x).error(n(s)("ai-agent.backend.configuration.noChatContext"))}},{label:n(s)("ai-agent.backend.configuration.feedback"),icon:"i-lucide-wrap-text",show:!d.agent.enableFeedback,onClick:(e,f)=>{const v=e.metadata?.annotations?.annotationId;v?ie(v,e.id):le(e,f)}}]},"spacing-offset":160},{content:_(({message:e,index:f})=>[e.content.length||e.metadata?.references&&e.metadata.references.length?(r(),k(c,{key:0,content:e.content.toString()},{before:_(()=>[e.status==="loading"?(r(),u("div",Oe,[m(w,{name:"i-lucide-loader-2",class:"animate-spin"}),p("span",null,b(n(s)("ai-chat.frontend.messages.thinking")),1)])):g("",!0)]),after:_(()=>[e.metadata?.references&&e.metadata.references.length>0&&e.role==="assistant"&&!n(S)&&d.agent.showReference?(r(),u(F,{key:0},[p("div",Qe,[p("span",ze,b(n(s)("ai-agent.backend.configuration.referenceTitle")),1),e.metadata?.references&&e.metadata.references.length>0&&e.role==="assistant"?(r(),k(q,{key:0,size:"xs",type:"dashed"})):g("",!0)]),m(ce,{references:e.metadata.references},null,8,["references"])],64)):g("",!0),e.metadata?.annotations&&e.role==="assistant"&&!n(S)?(r(),u("div",He,[p("span",je,b(e.metadata?.annotations?.createdBy)+" "+b(n(s)("ai-agent.backend.configuration.editedAnswer")),1),m(q,{size:"xs",type:"dashed"})])):g("",!0)]),_:2},1032,["content"])):g("",!0),e.metadata?.suggestions&&n(l).length-1===f?(r(),u("div",Ge,[(r(!0),u(F,null,U(e.metadata.suggestions,v=>(r(),u("div",{key:v},[m(i,{label:v,color:"primary",variant:"soft",onClick:We=>A(v)},null,8,["label","onClick"])]))),128))])):g("",!0)]),_:1},8,["messages","scroll-area-height","error","assistant"]))]),_:1})]),_:1},512),p("div",Je,[p("div",Ke,[(r(!0),u(F,null,U(d.agent.quickCommands,e=>(r(),u("div",{key:e.name},[m(i,{color:"neutral",variant:"soft",onClick:f=>A(e.content)},{default:_(()=>[e.avatar?(r(),k(de,{key:0,src:e.avatar,class:"h-4 w-4"},null,8,["src"])):g("",!0),p("span",null,b(e.name),1)]),_:2},1032,["onClick"])]))),128))]),m(pe,{modelValue:n(R),"onUpdate:modelValue":t[2]||(t[2]=e=>Ae(R)?R.value=e:null),"is-loading":n(S),class:"sticky bottom-0 z-10 [view-transition-name:chat-prompt]",onStop:n(ne),onSubmit:A},null,8,["modelValue","is-loading","onStop"])])])}}});export{Nt as default};
